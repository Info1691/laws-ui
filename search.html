<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search (beta) — Laws</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{ --bg:#f3f4f6; --ink:#111827; --mut:#6b7280; --ring:#e5e7eb; --card:#ffffff; }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f172a; --ink:#e5e7eb; --mut:#94a3b8; --ring:#1f2937; --card:#0b1220; }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    a{color:inherit;text-decoration:none}
    a:hover{text-decoration:underline}
    .bar{background:#0b2e47;color:#fff;padding:12px 18px;display:flex;gap:12px;align-items:center}
    .wrap{max-width:1000px;margin:20px auto;padding:0 16px}
    .panel{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type="search"]{flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--ring);border-radius:10px;font-size:16px;background:#fff}
    .count{font-size:.9rem;color:#6b7280}
    .list{list-style:none;margin:16px 0 0;padding:0}
    .item{background:#f8fafc;border:1px solid var(--ring);border-radius:12px;padding:14px 16px;margin:12px 0}
    .title{font-weight:800;margin:0 0 6px 0}
    .meta{font-size:.9rem;color:#6b7280;margin-bottom:8px}
    .chip{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:5px 10px;font-size:.8rem;background:#fff;color:#111827}
    .chip:hover{background:#eef2f7}
  </style>
</head>
<body>
  <div class="bar">
    <a href="./">&larr; Back</a>
    <strong>Search (beta)</strong>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="row">
        <input id="q" type="search" placeholder="Search laws (title / jurisdiction / body / year …)" autofocus />
        <span id="cnt" class="count"></span>
      </div>
      <ul id="out" class="list" aria-live="polite"></ul>
      <div class="count" style="margin-top:10px">
        Source: <span id="srcLabel">./laws.json</span>
      </div>
    </div>
  </div>

  <script>
    // Primary local JSON in this repo; fallback to public law-index if needed.
    const LAWS_URL_PRIMARY = './laws.json';
    const LAWS_URL_FALLBACK = 'https://info1691.github.io/law-index/laws/laws.json';

    const $q = document.getElementById('q');
    const $out = document.getElementById('out');
    const $cnt = document.getElementById('cnt');
    const $src = document.getElementById('srcLabel');

    let LAWS = [];

    const norm = v => (v ?? '').toString().toLowerCase();
    const tokens = s => norm(s).split(/\s+/).filter(Boolean);

    function resolveHref(it){
      const raw = (it.url || it.txt || it.path || '').toString().trim();
      if (!raw) return '#';
      if (/^https?:\/\//i.test(raw)) return raw;
      if (/^data\/|^texts\//i.test(raw)) return raw.replace(/^\.?\/*/, './');
      return 'https://info1691.github.io/law-index/' + raw.replace(/^\.?\/*/, '');
    }

    function row(it){
      const li = document.createElement('li'); li.className='item';
      const t = document.createElement('div'); t.className='title'; t.textContent = it.title || it.name || it.reference || 'Untitled';
      const m = document.createElement('div'); m.className='meta';
      const bits = [];
      if (it.jurisdiction) bits.push(String(it.jurisdiction).toUpperCase());
      if (it.body) bits.push(it.body);
      if (it.year) bits.push(it.year);
      if (it.reference) bits.push(it.reference);
      m.textContent = bits.join(' · ');
      const a = document.createElement('a'); a.className='chip'; a.textContent='TXT'; a.href=resolveHref(it); a.target='_blank'; a.rel='noopener';
      li.append(t,m,a);
      return li;
    }

    function render(items){
      $out.innerHTML = '';
      items.forEach(it => $out.appendChild(row(it)));
      $cnt.textContent = `${items.length} result${items.length===1?'':'s'}`;
    }

    function doSearch(){
      const q = tokens($q.value);
      if (!q.length){ render(LAWS); return; }
      const out = LAWS.filter(it => {
        const hay = [it.title, it.jurisdiction, it.body, it.year, it.reference].map(norm).join(' ');
        return q.every(t => hay.includes(t));
      });
      render(out);
    }

    async function load(){
      try{
        $src.textContent = LAWS_URL_PRIMARY;
        const r1 = await fetch(LAWS_URL_PRIMARY, {cache:'no-store'});
        if (!r1.ok) throw new Error(`HTTP ${r1.status}`);
        LAWS = await r1.json();
      }catch(e1){
        try{
          $src.textContent = LAWS_URL_FALLBACK;
          const r2 = await fetch(LAWS_URL_FALLBACK, {cache:'no-store'});
          if (!r2.ok) throw new Error(`HTTP ${r2.status}`);
          LAWS = await r2.json();
        }catch(e2){
          $out.innerHTML = '<li class="item">Failed to load laws.json from both sources.</li>';
          console.error('Primary error:', e1);
          console.error('Fallback error:', e2);
          return;
        }
      }
      render(LAWS);
    }

    load();
    $q.addEventListener('input', doSearch);
  </script>
</body>
</html>
